<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Board Creator (Fixed)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background-color: white;
        }
        .grid-container {
            position: relative;
            width: 350px;
            height: 250px;
            margin-bottom: 30px;
        }
        .grid-background {
            position: absolute;
            width: 100%;
            height: 100%;
            background-size: cover;
            z-index: 1;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(7, 50px);
            grid-template-rows: repeat(5, 50px);
            position: relative;
            width: 350px;
            height: 250px;
            z-index: 2;
        }
        .cell {
            width: 50px;
            height: 50px;
            position: relative;
        }
        .unit {
            width: 40px;
            height: 40px;
            position: absolute;
            top: 5px;
            left: 5px;
            z-index: 3;
            image-rendering: crisp-edges;
        }
        .omen-unit {
            position: relative;
            width: 40px;
            height: 40px;
            z-index: 4;
        }
        .omen-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: crisp-edges;
        }
        .omen-dot {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
        }
        .relic {
            position: absolute;
            width: 40px;
            height: 40px;
            top: 5px;
            left: 5px;
            background-size: contain;
            background-repeat: no-repeat;
            border: 2px solid;
            z-index: 2;
        }
        /* Reszta stylów pozostaje bez zmian */
    </style>
</head>
<body>
    <h1>Board Creator</h1>
    
    <div class="buttons">
        <button onclick="clearElements()">Clear All</button>
        <button onclick="saveAsImage()">Save as Image</button>
    </div>
    
    <div class="grid-container">
        <div class="grid-background" id="grid-bg"></div>
        <div class="grid" id="grid"></div>
    </div>
    
    <div id="image-container" style="display:none;">
        <h3>Generated Board</h3>
        <img id="generated-image" src="" alt="Generated board image">
    </div>

    <script>
        // 1. Inicjalizacja zasobów z prawidłowymi ścieżkami
        const assets = {
            background: './default.png',
            omen: './omen.png',
            relic: './relic.png',
            units: Array(30).fill().map((_, i) => `./image${i+1}.png`)
        };

        // 2. Preload obrazów z cache'owaniem
        async function preloadImages() {
            const images = [
                assets.background,
                assets.omen,
                assets.relic,
                ...assets.units
            ];
            
            await Promise.all(images.map(url => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = "Anonymous";
                    img.src = url;
                    img.onload = resolve;
                });
            });
            console.log("All assets preloaded");
        }

        // 3. Poprawiona funkcja generująca obraz
        async function saveAsImage() {
            try {
                console.log("Starting image generation...");
                
                const options = {
                    useCORS: true,
                    scale: 2,
                    logging: true,
                    backgroundColor: null,
                    allowTaint: false,
                    foreignObjectRendering: false
                };

                const canvas = await html2canvas(document.getElementById("grid"), options);
                const img = document.getElementById("generated-image");
                img.src = canvas.toDataURL("image/png");
                document.getElementById("image-container").style.display = "block";
                
                console.log("Image generated successfully");
            } catch (error) {
                console.error("Generation error:", error);
                alert("Error generating image. Check console.");
            }
        }

        // 4. Inicjalizacja planszy
        async function initBoard() {
            await preloadImages();
            
            // Ustaw tło
            document.getElementById("grid-bg").style.backgroundImage = `url(${assets.background})`;
            
            // Stwórz komórki
            const layout = [
                ["path", "green", "green", "green", "green", "green", "brown"],
                ["path", "path", "path", "green", "path", "path", "path"],
                ["green", "green", "path", "green", "path", "green", "green"],
                ["green", "green", "path", "green", "path", "green", "green"],
                ["green", "green", "path", "path", "path", "green", "green"]
            ];
            
            const grid = document.getElementById("grid");
            layout.forEach((row, rowIndex) => {
                row.forEach((cellType, colIndex) => {
                    const cell = document.createElement("div");
                    cell.classList.add("cell", cellType);
                    if (cellType === "green") {
                        cell.onclick = () => placeElement(cell);
                    }
                    grid.appendChild(cell);
                });
            });
        }

        // 5. Pozostałe funkcje
        function clearElements() {
            document.querySelectorAll(".unit, .omen-unit, .relic").forEach(el => el.remove());
        }

        // Start aplikacji
        document.addEventListener('DOMContentLoaded', initBoard);
    </script>
</body>
</html>
