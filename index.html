<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Board Creator (Fixed)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Zachowaj poprzednie style, ale zmodyfikuj tło */
        .grid-background {
            position: absolute;
            width: 100%;
            height: 100%;
            background-size: cover;
            z-index: 1;
        }
        
        /* Dodaj to dla pewności */
        img, .omen-image, .relic {
            display: block;
            max-width: 100%;
        }
    </style>
</head>
<body>
    <!-- Zachowaj poprzedni HTML, ale zmień sposób ładowania obrazków -->
    <div class="grid-container">
        <div class="grid-background" id="grid-bg"></div> <!-- Zmienione - obraz tła będzie ładowany przez JS -->
        <div class="grid" id="grid"></div>
    </div>

    <script>
        // 1. Ładowanie zasobów z prawidłowymi ścieżkami
        const assets = {
            background: './default.png',
            omen: './omen.png',
            relic: './relic.png',
            units: Array(30).fill().map((_, i) => `./image${i+1}.png`)
        };

        // 2. Inicjalizacja obrazów z cache'owaniem
        function preloadImages(urls) {
            return Promise.all(
                urls.map(url => {
                    return new Promise((resolve, reject) => {
                        const img = new Image();
                        img.crossOrigin = "Anonymous"; // Rozwiązanie CORS
                        img.src = url;
                        img.onload = () => resolve(img);
                        img.onerror = reject;
                    });
                })
            );
        }

        // 3. Funkcja generująca obrazek z poprawkami
        async function saveAsImage() {
            try {
                // Włącz dodatkowe logowanie
                console.log("Starting image generation...");
                
                const options = {
                    useCORS: true,
                    allowTaint: true,
                    scale: 2, // Lepsza jakość
                    logging: true,
                    backgroundColor: null,
                    removeContainer: true
                };

                const canvas = await html2canvas(document.getElementById("grid"), options);
                
                console.log("Canvas generated successfully");
                
                const img = document.getElementById("generated-image");
                img.src = canvas.toDataURL("image/png");
                document.getElementById("image-container").style.display = "block";
            } catch (error) {
                console.error("Generation failed:", error);
                alert("Error generating image. Check console for details.");
            }
        }

        // 4. Inicjalizacja - ładowanie zasobów przed użyciem
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const [bgImg] = await preloadImages([assets.background]);
                document.getElementById("grid-bg").style.backgroundImage = `url(${bgImg.src})`;
                
                console.log("Assets loaded successfully");
            } catch (error) {
                console.error("Error loading assets:", error);
            }
        });

        // 5. Zmodyfikowana funkcja placeElement - upewnij się, że używa preloadImages
        async function placeElement(event) {
            if (selectedUnit) {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.src = selectedUnit;
                await new Promise((resolve) => { img.onload = resolve; });
                
                // Reszta logiki dodawania elementów...
            }
        }
    </script>

    <!-- Reszta Twojego kodu pozostaje bez zmian -->
</body>
</html>
